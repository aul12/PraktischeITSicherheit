\section{How does Intel SGX work}

\begin{frame}
    \frametitle{Overview}
    \begin{itemize}[<+->]
        \item Application is split into a secure part and a non-secure part
        \begin{itemize}
            \item Trusted functions processing secrets (e.g. passwords, encryption keys)
            \item Untrusted functions for non-critical computations / procedures
        \end{itemize}
        \item Trusted functions are handled by so called ``enclaves``
        \item Enclave is launched by the application
        \item Enclave code is called by the application through enclave entry point
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{Overview}
    \begin{itemize}[<+->]
        \item Enclaves can be seen as shared objects (.so on Unix, .dll on Windows) which provide trusted functions
        \item Trusted functions should only handle security critical procedures (e.g. password reads)
        \item Enclave memory can only be read by trusted functions
    \end{itemize}
    $ $ \newline
    \centering
    \visible<4>{\incfig[0.4\textwidth]{Enclave}}
\end{frame}

%Quellen unten anpassen
\incfuck[0.8\textwidth]{AppOverview}{1}{{}}{Overview}
\incfuck[0.8\textwidth]{AppOverview}{2}{{}}{Overview}
\incfuck[0.8\textwidth]{AppOverview}{3}{{}}{Overview}
\incfuck[0.8\textwidth]{AppOverview}{4}{{}}{Overview}
\incfuck[0.8\textwidth]{AppOverview}{5}{{}}{Overview}
\incfuck[0.8\textwidth]{AppOverview}{6}{{}}{Overview}
\incfuck[0.8\textwidth]{AppOverview}{7}{{}}{Overview}
\incfuck[0.8\textwidth]{AppOverview}{8}{{}}{Overview}


\begin{frame}
    \frametitle{Implementation: SGX Memory Layout}
    \begin{itemize}[<+->]
        \item Code and data of enclaves is stored in a special memory area, called Enclave Page Cache (EPC)
        \item Each EPC-page is owned by exactly one enclave
        \item Enclave Page Cache Map (EPCM) determines mapping from enclave to EPC-pages
        \item EPCM also records for each EPC-page the corresponding virtual address
        \item EPC and EPCM reside in reserved part of system memory (Processor Reserved Memory (PRM))
        \item CPU denies direct access to PRM even by OS, BIOS, etc \dots
        \item PRM is encrypted on hardware level
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{Implementation: SGX Memory Layout}
    \centering
    \incfig[0.6\textwidth]{MemoryLayout}
\end{frame}

\begin{frame}
    \frametitle{Implementation: SGX Enclave Control Structure (SECS)}
    \begin{itemize}[<+->]
        \item SGX stores per-enclave metadata in an SECS associated with each enclave
        \item SECS is stored in an EPC-page of the corresponding enclave
        \item SECS cannot be accessed by the enclave
        \item SECS contains:
        \begin{itemize}
            \item Enclave ID
            \item Enclave state (un-/initialized)
            \item Enclave Measurement (see also slide \ref{fr:EncSig})
            \item Enclave size
            \item \dots
        \end{itemize}
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{Implementation: Enclave Mode}
    \begin{itemize}[<+->]
        \item SGX adds a new CPU mode i.e. the ``Enclave Mode``
        \begin{itemize}
            \item Standard application code runs in ``untrusted mode``
            \item Enclave code (i.e. trusted functions) run in enclave mode
        \end{itemize}
        \item Code running in untrusted mode cannot access EPC-pages
        \item Code running in enclave mode can access untrusted memory / code
        \item Modes can be switched by special CPU-instructions
    \end{itemize}
    $ $ \newline
    \centering
    \visible<6>{
        \begin{tabular}{l | l}
        Standard CPU-modes & SGX-modes \\
        \hline
        User mode & Untrusted mode \\
        Kernel mode & Enclave mode \\
    \end{tabular}}
\end{frame}

\begin{frame}
    \frametitle{Implementation: Page Mapping and Page Checks}
    \begin{itemize}[<+->]
        \item Address translation and page mapping is delegated to the system software \newline
              $\Rightarrow$ small overhead, standard address translation is used
        \item Since the OS is not trusted, additional checks have to be performed by the CPU
        \item Intel SGX ensures that: 
            \begin{itemize}
                \item virtual addresses pointing to enclave code or data are mapped to EPC-pages
                \item EPC-pages can only be mapped to one specific virtual address
                \item EPC-pages are allocated to exactly one enclave (by checking the EPCM)
            \end{itemize}
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{Extended Page Check}
    \begin{figure}
        \centering
        \incfig[0.75\textwidth]{PageCheck}
        \caption*{Source: \url{https://blog.quarkslab.com/overview-of-intel-sgx-part-1-sgx-internals.html}}
    \end{figure}
\end{frame}

\begin{frame}
    \frametitle{Implementation: Special Instructions}
    \begin{itemize}[<+->]
        \item SGX introduces new CPU instructions which are used to:
        \begin{itemize}
            \item Switch between untrusted mode and enclave mode (EENTER, EEXIT)
            \item Create and tear down enclaves (ECREATE, EREMOVE, EINIT, EADD)
            \item Compute cryptographic signatures for attestation process (EGETKEY, EREPORT, EEXTEND)
        \end{itemize}
        \item Instructions are implemented in micro code
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{Implementation: Execution Privileges}
    \begin{itemize}[<+->]
        \item Enclave creation is only possible in kernel mode (page allocation)
        \item Switching between enclave an untrusted CPU mode can only be done in user mode
        \item All enclave code runs with standard user privileges \newline
              $\Rightarrow$ standard security mechanisms of OS are applied    
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{Implementation: Enclave Live Cycle}
    \centering
    \incfig[0.85\textwidth]{EnclaveLiveCycle}
\end{frame}

\begin{frame}
    \frametitle{Implementation: Enclave Signature}
    \label{fr:EncSig}
    \begin{itemize}[<+->]
        \item Enclaves signature is used to verify the loaded enclave
        \item It contains (among other information):
        \begin{itemize}
            \item The ``Enclave Measurement`` (hash value of enclave code and data)
            \item The authors public key
            \item The authors signature
            \item Different version numbers (product ID, module version, \dots)
        \end{itemize}
        \item During EINIT the enclave to be created is measured and the result is compared against the expected measurement in the enclave signature
        \item A mismatch will prevent the enclave from execution
    \end{itemize}
\end{frame}

\incfuck[\textwidth]{EnclaveCreation}{1}{}{Enclave Creation Step by Step}    
\incfuck[\textwidth]{EnclaveCreation}{2}{}{Enclave Creation Step by Step}    
\incfuck[\textwidth]{EnclaveCreation}{3}{}{Enclave Creation Step by Step}    
\incfuck[\textwidth]{EnclaveCreation}{4}{}{Enclave Creation Step by Step}    
\incfuck[\textwidth]{EnclaveCreation}{5}{}{Enclave Creation Step by Step}    
\incfuck[\textwidth]{EnclaveCreation}{6}{}{Enclave Creation Step by Step}    
\incfuck[\textwidth]{EnclaveCreation}{7}{}{Enclave Creation Step by Step}    
\incfuck[\textwidth]{EnclaveCreation}{8}{}{Enclave Creation Step by Step}    
\incfuck[\textwidth]{EnclaveCreation}{9}{}{Enclave Creation Step by Step}    

\begin{frame}
    \frametitle{UNTIL HERE THE PRESENTATION IS MORE OR LESS FINISHED}
    Following slides is mainly the stuff that has already been mentioned but in an unrefined version.
    After that slides for attestation and sealing follow but are not finished yet since we are not sure
    how much additional content will actually fit in the presentation.

\end{frame}

\begin{frame}
    \frametitle{Enclave Page Cache (EPC)}
    \begin{itemize}
        \visible<1->{\item Code and data of the enclave is stored in a special memory area, called EPC}
        \visible<2->{\item This area is encrypted by using the Memory Encryption Engine (MEE)}
        \visible<3->{\item MEE is an extra new and dedicated circuit for Intel SGX}
        \visible<4->{\item Only enclave can read from its own EPC}
        \visible<5->{\item EPC page content is only decrypted inside the CPU}
        \visible<6->{\item Keys for de-/encrypting are generated at boot-time and are stored inside the CPU}
        \visible<7>{\item Enclaves can access their application memory, but not the other way arround}
    \end{itemize}
\end{frame}


\begin{frame}
    \frametitle{Local Attestation}
    \begin{itemize}
        \visible<1->{\item Enclaves can communicate to each other}
        \visible<2->{\item Local attestation is a proof, that the other enclave exists and is trustable}
        \visible<3>{\item A channel must have been established between the two enclaves}
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{Local Attestation}
    \begin{enumerate}
        \visible<1->{\item The first enclave can ask the hardware to generate a credential, named report, and send it to the other enclave}
        \visible<2->{\item The second can verify, that this resport is generated on the same platform and can now trust this enclave}
        \visible<3>{\item The second enclave has also to proof the report of the first enclave}
    \end{enumerate}
\end{frame}

%vielleicht mit Bild als erkl√§rung leichter????????

\begin{frame}
    \frametitle{Remote Attestation}
    \begin{itemize}
        \visible<1->{\item Remote attestation is an exchange of a ``quote``}
        \visible<2->{\item Remote attestation needs an extra architectural enclave, called ``quoting enclave``}
        \visible<3->{\item This extra enclave is an architectural enclave, called ``quoting enclave``}
        \visible<4->{\item The quoting enclave verifies and transforms the enclave report into a quote}
        \visible<5->{\item A quote is signed by the quoting enclave by the Provisioning Key}
        \visible<6>{\item This quote is remotely verifiable}
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{Remote Attestation}
    \begin{enumerate}
        \visible<1->{\item An attestation request is send from a server to the application}
        \visible<2->{\item The application sends a report request to the application enclave}
        \visible<3->{\item The application enclave returns the generated report}
        \visible<4->{\item The application receives the report and forwards it to the quoting enclave to be signed}
        \visible<5->{\item The quoting enclave generates from the report a quote and the quote is send back to the application}
        \visible<6->{\item The application sends the quote to the server for verification}
        \visible<7->{\item The server validates the quote signature and the server sends the data to the attestation service}
    \end{enumerate}
\end{frame}

%vielleicht mit Bild als erkl√§rung leichter????????

\begin{frame}
    \frametitle{Sealing}
    \begin{itemize}
        \visible<1->{\item Process of encrypting enclave secrets for persistent sorage is calles sealing}
        \visible<2->{\item Different ways of sealing}
        \visible<3->{\item Enclave retrieves the seal Key using the EGETKEY instruction, which returns a cryptographical key}
        \visible<4>{\item Key is used to encrypt and ensure data integrity}
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{Sealing - Different ways}
    \begin{itemize}
        \visible<1->{\item Enclave Identity}
        \visible<2->{\begin{itemize}
            \item Two distinct enclaves have different keys
            \item Sealed data will not be available to different versions of the same enclave
            \item Sealed data will only be available to identical enclave instantiations
        \end{itemize}}
        \visible<3->{\item Signer Identity}
        \visible<4->{\begin{itemize}
            \item Two distinct enclaves have different keys
            \item Two versions of an enclave share the same key
            \item multiple enclaves which are using the same key can all read each others data
        \end{itemize}}
        \visible<5->{\item Security Version Number (SVN)}
        \visible<6>{\begin{itemize}
            \item SVN is a counter which is incremented after each update
            \item Older versions of an enclave are not available to read data from a newer version
            \item keys are derived that an enclave can retrieve the keys corresponding to current or older security level
        \end{itemize}}
    \end{itemize}

    

\end{frame}

